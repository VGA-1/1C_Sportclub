Процедура ОбработкаПроведения(Отказ, РежимПроведения)
    
    Если Не ПроверитьВозможностьЗаморозки() Тогда
        Отказ = Истина;
        Возврат;
    КонецЕсли;
    
    ОбновитьСтатусАбонемента(Перечисления.СтатусАбонемента.Заморожен);
    
КонецПроцедуры

Функция ПроверитьВозможностьЗаморозки()
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    Периодический.Статус КАК Статус,
    |    Периодический.ДоступноЗаморозок КАК ДоступноЗаморозок,
    |    Периодический.ДатаОкончания КАК ДатаОкончанияАбонемента
    |ИЗ
    |    РегистрСведений.СостояниеАбонемента.СрезПоследних(
    |        , 
    |        Абонемент = &Абонемент
    |    ) КАК Периодический";
    
    Запрос.УстановитьПараметр("Абонемент", Абонемент);
    Результат = Запрос.Выполнить().Выбрать();
    
    Если НЕ Результат.Следующий() Тогда
        Сообщить("Абонемент не найден в регистре состояний");
        Возврат Ложь;
    КонецЕсли;
    
    Если Результат.Статус <> Перечисления.СтатусАбонемента.Активен Тогда
        Сообщить("Заморозка возможна только для активных абонементов");
        Возврат Ложь;
    КонецЕсли;
    
    Если Результат.ДоступноЗаморозок <= 0 Тогда
        Сообщить("Лимит заморозок исчерпан");
        Возврат Ложь;
    КонецЕсли;
    
    Если Результат.ДатаОкончанияАбонемента <> Неопределено 
        И Результат.ДатаОкончанияАбонемента < ТекущаяДата() Тогда
        Сообщить("Абонемент уже закрыт");
        Возврат Ложь;
    КонецЕсли;
    
    СрокЗаморозки = (ДатаОканчания - ДатаНачала)/86400;
    Если СрокЗаморозки > 90 Тогда 
        Сообщить("Срок заморозки не может превышать 3 месяцев");
        Возврат Ложь;
    КонецЕсли;
    
    Возврат Истина;
    
КонецФункции

Процедура ОбновитьСтатусАбонемента(НовыйСтатус)
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    Периодический.Статус КАК Статус,
    |    Периодический.ДоступноЗаморозок КАК ДоступноЗаморозок,
    |    Периодический.ДатаОкончания КАК ДатаОкончания,
    |    Периодический.ОстатокПосещений КАК ОстатокПосещений
    |ИЗ
    |    РегистрСведений.СостояниеАбонемента.СрезПоследних(,  Абонемент = &Абонемент) КАК Периодический";
    
    Запрос.УстановитьПараметр("Абонемент", Абонемент);
    Результат = Запрос.Выполнить().Выбрать();
    
    ЗаписьРегистра = РегистрыСведений.СостояниеАбонемента.СоздатьМенеджерЗаписи();
    ЗаписьРегистра.Период = ТекущаяДата();
    ЗаписьРегистра.Абонемент = Абонемент;
    ЗаписьРегистра.Статус = НовыйСтатус;
    ЗаписьРегистра.ДатаИзменения = ТекущаяДата();
    
    Если Результат.Следующий() Тогда
        ЗаписьРегистра.ОстатокПосещений = Результат.ОстатокПосещений;
        Если НовыйСтатус = Перечисления.СтатусАбонемента.Заморожен Тогда
            ЗаписьРегистра.ДоступноЗаморозок = Макс(0, Результат.ДоступноЗаморозок - 1);
            Если Результат.ДатаОкончания <> Неопределено 
                И ДатаНачала <> Неопределено 
                И ДатаОканчания <> Неопределено Тогда
                СрокЗаморозкиВДнях = ДатаОканчания - ДатаНачала;                
                Если СрокЗаморозкиВДнях > 0 Тогда
                    НоваяДатаОкончания = Результат.ДатаОкончания + СрокЗаморозкиВДнях;
                    ЗаписьРегистра.ДатаОкончания = НоваяДатаОкончания;
                Иначе
                    ЗаписьРегистра.ДатаОкончания = Результат.ДатаОкончания;
                КонецЕсли;
            Иначе
                ЗаписьРегистра.ДатаОкончания = Результат.ДатаОкончания;
            КонецЕсли;
        Иначе
            ЗаписьРегистра.ДоступноЗаморозок = Результат.ДоступноЗаморозок;
            ЗаписьРегистра.ДатаОкончания = Результат.ДатаОкончания;
        КонецЕсли;
    Иначе
        ЗаписьРегистра.ДоступноЗаморозок = 100; 
        Сообщить("Абонемент не найден в регистре состояний. Создана новая запись.");
    КонецЕсли;
    
    ЗаписьРегистра.Записать();
    
КонецПроцедуры